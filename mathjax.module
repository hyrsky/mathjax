<?php
/**
 * @file
 * MathJax module.
 */

use Drupal\mathjax\Mathjax\Defaults;

/**
 * Implements hook_permission().
 */
function mathjax_permission() {
  return array(
    'administer mathjax' => array(
      'title' => t('Administer MathJax'),
    ),
  );
}

/**
 * Implements hook_help().
 */
function mathjax_help($path, $arg) {
  switch ($path) {
    // Main module help for the mathjax module.
    case 'admin/config/content/mathjax':
      return t('MathJax allows you to include mathematics in your web pages, either using TeX and LaTeX notation, or as MathML, and you can even use both in the same document. Go to the <a href="@url">MathJax website</a> for more information.', array('@url' => url('http://www.mathjax.org/')));

    case 'admin/help#mathjax':
      return '<p>' . t('MathJax allows you to include mathematics in your web pages, either using TeX and LaTeX notation, or as MathML, and you can even use both in the same document. Go to the <a href="@url">MathJax website</a> for more information.', array('@url' => url('http://www.mathjax.org/'))) . '</p>';
  }
}

/**
 * Implements hook_page_build().
 */
function mathjax_page_build(&$page) {
  global $base_path;
  $config = Drupal::config('mathjax.settings');

  if ($config->get('mathjax_config_type') == 0) {
    $config_string = Defaults::CONFIG;
  }
  else {
    $config_string = !is_null($config->get('mathjax_config_string')) ? $config->get('mathjax_config_string') : Defaults::CONFIG;
  }
  // Load Mathjax.
  $page['#attached']['js'][] = array(
    'type' => 'inline',
    'data' => $config_string,
    'every_page' => TRUE,
    'weight' => -10,
  );
  if (!is_null($config->get('mathjax_use_cdn')) ? $config->get('mathjax_use_cdn') : TRUE) {
    $cdn_url = !is_null($config->get('mathjax_cdn_url')) ? $config->get('mathjax_cdn_url') : Defaults::CDNURL;
    $page['#attached']['js'][$cdn_url] = array('every_page' => TRUE, 'type' => 'external');
  }
  else {
    // Use the local library.
    $library = DRUPAL_ROOT . $base_path . libraries_get_path('mathjax') . '/MathJax.js';
    if (file_exists($library)) {
      $page['#attached']['js'][$base_path . libraries_get_path('mathjax') . '/MathJax.js?config=TeX-AMS-MML_HTMLorMML'] = array('every_page' => TRUE, 'type' => 'external');
    }
    else {
      // Throw an error.
      drupal_set_message('MathJax is configured to load from a local library, but could not find the library files. Check the module settings.', 'error');
    }
  }
}
